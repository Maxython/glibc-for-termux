# The original PKGBUILD was taken from the gitlab.archlinux.org/archlinux/packaging repo:
# - https://gitlab.archlinux.org/archlinux/packaging/packages/glibc/-/blob/main/PKGBUILD

pkgname=glibc
pkgver=2.37
pkgrel=10
_commit=be176490b818b65b5162c332eb6b581690b16e5c
pkgdesc="GNU C Library"
arch=(any)
url='https://www.gnu.org/software/libc/'
license=('GPL' 'LGPL')
options=(!strip staticlibs)
source=(https://ftp.gnu.org/gnu/libc/glibc-$pkgver.tar.xz
	'_Fork.c.patch'
	'dl-tls_init_tp.c.patch'
	'pthread_create.c.patch'
        'faccessat.c.patch'
        'tst-rseq-disable.c.patch'
        'tst-rseq.h.patch'
        'rseq-internal.h.patch'
        'disable-clone3.patch'
        'locale-gen'
        'locale.gen.txt'
        'sdt-config.h'
        'sdt.h'
	'grun'
	'statx.c.patch'
	'xstat64.c.patch'
	'lxstat64.c.patch'
	'fxstatat64.c.patch'
	'fxstat64.c.patch'
	'fstatat64.c.patch'
	'clock_gettime.c.patch'
        'chmod.c.patch'
        'send.c.patch'
        'setdirs.patch'
        'recv.c.patch'
        'accept.c.patch'
        'shmem-android.h'
        'shmget.c.patch'
        'shmat.c.patch'
        'shmctl.c.patch'
        'shmdt.c.patch'
        'ftruncate.c.patch'
        'aarch64-arch-syscall.h.patch'
        'arm-arch-syscall.h.patch'
        'x86_64-arch-syscall.h.patch'
        'i386-arch-syscall.h.patch'
        'mprotect.c')
sha256sums=('2257eff111a1815d74f46856daaf40b019c1e553156c69d48ba0cbfc1bb91a43'
            '74da3d03fb81e2511140411bc8bad2a893258a2465c5eec5ac955dccddf9621d'
            '9223be94da6667f0dff0bf7afb032932dd9a151f23af178faa4d1d7f26c58608'
            'dd0f14f9ccca83424bc2b841346047d16c59d229c1a459fc764e6c67f4fe91ba'
            '6814b1c02455fc482d7ea340112bcca1cdd4e13ca2c16f156654d7a65dbdcda2'
            '27e1ea17f40c57f6bac2e46816d0684170818b58ecced7a83efb8e7f0f038af0'
            'b6286fe9ffd9707d171db5dd53b3c084d7d38402e1a32eb8b9bd455d9a8b5ab6'
            'ec053954ab9e19b850227048a61e622bd15d6a651fd7498e507e908485374299'
            '0f778f5a2d20e8710647370e89c793eb27bbf8ef9824558d0154185c91ecd12c'
            'cdd916c0dc29e5d958ddef5c3530947244fd740ce7645601bfabae53512323b8'
            'd42648cea552ba5353a32e264686e992263289d5cc86207314dffc54ab514981'
            'cdc234959c6fdb43f000d3bb7d1080b0103f4080f5e67bcfe8ae1aaf477812f0'
            '774061aff612a377714a509918a9e0e0aafce708b87d2d7e06b1bd1f6542fe70'
            '17e408e3d587551146d85741f932241e0bf60899490bb73195a2bd391510f099'
            'e0f6a51cbd64a30394d6a22e5e14603766ac924e9b6690adb673517821c2015e'
            'e67383acf8935a68353f0f1c786161222fbb08c9255cffa3ccb06565e1401cbc'
            'cd981ed4c8b77ee1551ae5a017dcc9b7891a6078450633eafe528e3984254f40'
            'e6b3bac73759e231cfa0099be3ca50f7b5a379ecdac18a598999e87d51c8f249'
            '6ec88f600395da72987fdc3fcd09ac0b992770201a6a7f1a377445a35f0ea52d'
            'a6ea8efc55de0e26494bf8839ae32d95c36b6956788535a9a8912ad989510f36'
            '18f01ed2c6ed8acb122adc443fd428c8a37bc6a7d518f4e433e2ee462eebd5eb'
            '769b294e226877f12d47ac4ff86ab9246da6e547781071c1ee38e60772484c74'
            'f5b5b6ae3596f6fd617d015ff9c417a35da37c86ae3a49b5b5ce88275ed09f12'
            '743c2fe91676cd8ce6eb520286abd28d9ad2764180894aad49d5be17dab3ab0c'
            'b8b573fcb85d59fc11ddef9aebb691b8047d700ea1894784883a1359c6ef94a8'
            '59e711916c946fc961bb8c3a0da5d367a90ffedd31bbf7cf250e9bc1e1e04744'
            '0298e3d4aca6e7db5d674f318a31cb68257bcba0cac66828b00202e012cbf567'
            'd7569b8f5aa1816461cf42e8f290ea861157ebb8da936c6fa472593e681737f2'
            '8a246f04d34253504bae46cf29e3e217c031f987b191de0fb2dafa38437e3809'
            '210e48732cdad2a2b01cff15771fcf12730bdad3f2a93ef772c03c8b57c74cc7'
            'e32f030f1f3d42974c3014e8ee3b78084046642d649d496fab31021a1991b2b7'
            '645dbf18806320f6381cec70ec5c7cd2ee7ccb6c5546f8e169fe31a55f1d419b'
            '4ee6aaf740d18758de333a38e979791197ae3053f91fefe83871639de525601c'
            '6a63b915b8f50e05a9a2287241e907f0c2a2b39f8d696c18a3e23267805d6a92'
            'f29c92c48adae65e86256b4ae5180c77aa6957d90bbc7abb54042c2820b2a26f'
            'e378b410d1f1750b7751910dffcd525f58be71ab1b4f54a09e1eedd7fa3829f4'
            '8951c11eb881bf3da35146986cacd321dfb9f6d776dc620304f64251cc185b12')
groups=('gpkg-dev')

prepare() {
  for i in *.patch; do
    patch -Np1 -i ${srcdir}/$i
  done

  for i in shmem-android.h mprotect.c; do
    install -Dm644 "${srcdir}/${i}" "glibc-$pkgver/sysdeps/unix/sysv/linux/${i}"
  done

  rm glibc-$pkgver/sysdeps/unix/sysv/linux/*/clone3.S

  mkdir -p glibc-build
}

build() {
  cd glibc-build
  echo "slibdir=$GLIBC_PREFIX/lib" > configparms
  echo "rtlddir=$GLIBC_PREFIX/lib" >> configparms
  echo "sbindir=$GLIBC_PREFIX/bin" >> configparms
  echo "rootsbindir=$GLIBC_PREFIX/bin" >> configparms

  unset CFLAGS
  ../glibc-$pkgver/configure \
      --prefix=$GLIBC_PREFIX \
      --libdir=$GLIBC_PREFIX/lib \
      --libexecdir=$GLIBC_PREFIX/lib \
      --host=$GPKG_DEV_TARGET \
      --build=$GPKG_DEV_TARGET \
      --target=$GPKG_DEV_TARGET \
      --with-bugurl=https://github.com/termux-pacman/glibc-packages/issues \
      --enable-bind-now \
      --enable-cet \
      --disable-multi-arch \
      --enable-stack-protector=strong \
      --enable-systemtap \
      --disable-profile \
      --disable-crypt \
      --disable-werror CFLAGS="-O2 -pipe"

  echo "build-programs=no" >> configparms
  make -O

  sed -i "/build-programs=/s#no#yes#" configparms
  echo "CFLAGS=-O2 -pipe" >> configparms
  make -O
  make info

  localedef -c -f ../glibc-$pkgver/localedata/charmaps/UTF-8 -i ../glibc-$pkgver/localedata/locales/C ../C.UTF-8/
}

package() {
  make -C glibc-build install_root="$pkgdir" install
  rm -f "$pkgdir"/$GLIBC_PREFIX/etc/ld.so.{cache,conf}

  # Shipped in tzdata
  rm -f "$pkgdir"/$GLIBC_PREFIX/bin/{tzselect,zdump,zic}

  cd glibc-$pkgver

  install -dm755 "$pkgdir"/$GLIBC_PREFIX/lib/{locale,systemd/system,tmpfiles.d}
  install -m644 nscd/nscd.conf "$pkgdir/$GLIBC_PREFIX/etc/nscd.conf"
  install -m644 nscd/nscd.service "$pkgdir/$GLIBC_PREFIX/lib/systemd/system"
  install -m644 nscd/nscd.tmpfiles "$pkgdir/$GLIBC_PREFIX/lib/tmpfiles.d/nscd.conf"
  install -dm755 "$pkgdir/$GLIBC_PREFIX/var/db/nscd"

  install -m644 posix/gai.conf "$pkgdir"/$GLIBC_PREFIX/etc/gai.conf

  install -m755 "$srcdir/locale-gen" "$pkgdir/$GLIBC_PREFIX/bin"

  # Create /etc/locale.gen
  install -m644 "$srcdir/locale.gen.txt" "$pkgdir/$GLIBC_PREFIX/etc/locale.gen"
  sed -e '1,3d' -e 's|/| |g' -e 's|\\| |g' -e 's|^|#|g' \
    "$srcdir/glibc-$pkgver/localedata/SUPPORTED" >> "$pkgdir/$GLIBC_PREFIX/etc/locale.gen"

  # install C.UTF-8 so that it is always available
  install -dm755 "$pkgdir/$GLIBC_PREFIX/lib/locale"
  cp -r "$srcdir/C.UTF-8" -t "$pkgdir/$GLIBC_PREFIX/lib/locale"
  sed -i '/#C\.UTF-8 /d' "$pkgdir/$GLIBC_PREFIX/etc/locale.gen"

  # Provide tracing probes to libstdc++ for exceptions, possibly for other
  # libraries too. Useful for gdb's catch command.
  install -Dm644 "$srcdir/sdt.h" "$pkgdir/$GLIBC_PREFIX/include/sys/sdt.h"
  install -Dm644 "$srcdir/sdt-config.h" "$pkgdir/$GLIBC_PREFIX/include/sys/sdt-config.h"

  sed -i "s|!/bin/bash|!$TERMUX_PREFIX/bin/bash|" "$pkgdir"/$GLIBC_PREFIX/bin/*
  mkdir -p "$pkgdir"/$TERMUX_PREFIX/bin
  install -m755 "$srcdir/grun" "$pkgdir/$TERMUX_PREFIX/bin"

  replace_hard_with_symbolic "$pkgdir"
}
